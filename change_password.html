<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure OTP Password Reset</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Poppins',sans-serif;
}
body{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#1e1e2f;
}
.container{
  width:380px;
  background:#2a2a3d;
  border-radius:20px;
  padding:40px 30px;
  box-shadow:0 25px 50px rgba(0,0,0,0.6);
  text-align:center;
  color:#fff;
}
.container h2{
  font-size:26px;
  margin-bottom:25px;
  color:#ff6a00;
}
input{
  width:100%;
  padding:14px 16px;
  margin:10px 0;
  border-radius:12px;
  border:none;
  background:#3b3b50;
  color:#fff;
  font-size:16px;
  outline:none;
}
input:focus{
  background:#4b4b6b;
  box-shadow:0 0 10px #ff6a00;
}
button{
  width:100%;
  padding:14px;
  margin:12px 0;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  background:#ff6a00;
  color:#fff;
}
button:hover{
  transform:translateY(-2px);
}
.section{
  display:none;
  animation:fadeIn .4s ease forwards;
}
#phoneBox{display:block;}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
#msg{
  margin-top:15px;
  font-weight:600;
}

/* PASSWORD STRENGTH */
.strength-bar{
  height:6px;
  background:#444;
  border-radius:6px;
  overflow:hidden;
  margin-bottom:10px;
}
.strength-bar-fill{
  height:100%;
  width:0%;
  transition:.3s;
}
.strength-weak{background:#ff3e3e;}
.strength-medium{background:#ffd500;}
.strength-strong{background:#4cd137;}
#strength{text-align:left;font-size:14px;margin-bottom:8px;}
</style>
</head>

<body>

<div class="container">
<h2>Reset Password</h2>

<!-- PHONE -->
<div id="phoneBox" class="section">
  <input type="text" id="phone" placeholder="Enter phone number">
  <div id="recaptcha-container" style="margin:15px 0;"></div>
  <button onclick="sendOTP()">Send OTP</button>
</div>

<!-- OTP -->
<div id="otpBox" class="section">
  <input
    type="text"
    id="otp"
    placeholder="Enter 6-digit OTP"
    maxlength="6"
    inputmode="numeric"
    pattern="[0-9]*"
  >
  <button onclick="verifyOTP()">Verify OTP</button>
  <button id="resendBtn" onclick="resendOTP()" style="display:none;">Resend OTP</button>
</div>

<!-- PASSWORD -->
<div id="passBox" class="section">
  <input type="password" id="newpass" placeholder="New Password">
  <div class="strength-bar">
    <div id="strengthBar" class="strength-bar-fill"></div>
  </div>
  <div id="strength"></div>
  <button onclick="changePassword()">Change Password</button>
</div>

<div id="msg"></div>
</div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyDLepAVQYijhcs0dOyH0gZS38iUtH_BbvA",
  authDomain: "college-chatbot-c9e6c.firebaseapp.com",
  projectId: "college-chatbot-c9e6c"
});
const auth = firebase.auth();

/* RECAPTCHA */
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
  'recaptcha-container',{size:'normal'}
);
recaptchaVerifier.render();

let confirmationResult;
function msg(t){document.getElementById("msg").innerText=t;}

/* SEND OTP */
function sendOTP(){
  let phone=document.getElementById("phone").value.trim();
  if(phone.match(/^\d{10}$/)) phone="+91"+phone;
  if(!phone.match(/^\+\d{10,15}$/)){
    msg("Invalid phone number ‚ùå");return;
  }
  auth.signInWithPhoneNumber(phone,window.recaptchaVerifier)
  .then(res=>{
    confirmationResult=res;
    phoneBox.style.display="none";
    otpBox.style.display="block";
    msg("OTP sent ‚úÖ");
    setTimeout(()=>resendBtn.style.display="block",60000);
  })
  .catch(e=>msg(e.message));
}

/* FORCE OTP NUMERIC ONLY */
const otpInput=document.getElementById("otp");
otpInput.addEventListener("input",()=>{
  otpInput.value=otpInput.value.replace(/[^0-9]/g,"");
});

/* VERIFY OTP */
function verifyOTP(){
  const otp=otpInput.value.trim();
  if(!/^\d{6}$/.test(otp)){
    msg("OTP must be exactly 6 digits ‚ùå");
    return;
  }
  confirmationResult.confirm(otp)
  .then(()=>{
    otpBox.style.display="none";
    passBox.style.display="block";
    msg("OTP verified ‚úî");
  })
  .catch(()=>msg("Invalid OTP ‚ùå"));
}

/* PASSWORD STRENGTH */
const newPass=document.getElementById("newpass");
const strengthBar=document.getElementById("strengthBar");
const strengthText=document.getElementById("strength");

newPass.addEventListener("input",()=>{
  let s=0,v=newPass.value;
  if(v.length>=8)s++;
  if(/[a-z]/.test(v))s++;
  if(/[A-Z]/.test(v))s++;
  if(/[0-9]/.test(v))s++;
  if(/[\W]/.test(v))s++;

  if(s<=2){
    strengthText.innerText="Weak üî¥";
    strengthBar.className="strength-bar-fill strength-weak";
    strengthBar.style.width="33%";
  }else if(s<=4){
    strengthText.innerText="Medium üü°";
    strengthBar.className="strength-bar-fill strength-medium";
    strengthBar.style.width="66%";
  }else{
    strengthText.innerText="Strong üü¢";
    strengthBar.className="strength-bar-fill strength-strong";
    strengthBar.style.width="100%";
  }
});

/* CHANGE PASSWORD */
function changePassword(){
  const pass=newPass.value.trim();
  if(pass.length<8){
    msg("Password must be 8+ characters ‚ùå");
    return;
  }
  fetch("/reset_password",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      phone:document.getElementById("phone").value.trim(),
      password:pass
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      msg("Password updated üéâ");
      setTimeout(()=>location.href="/login",2500);
    }else msg("Update failed ‚ùå");
  })
  .catch(()=>msg("Server error ‚ùå"));
}
</script>

</body>
</html>
